"""Issue 26: Add AI ranking fields to Profile model

Revision ID: 559654b37248
Revises: 0f28d1979fa3
Create Date: 2025-11-17 22:24:16.054462

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '559654b37248'
down_revision = '0f28d1979fa3'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('email_templates',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('subject', sa.String(length=255), nullable=False),
    sa.Column('html_body', sa.Text(), nullable=False),
    sa.Column('text_body', sa.Text(), nullable=True),
    sa.Column('variables', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('version', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_email_templates_id'), 'email_templates', ['id'], unique=False)
    op.create_index(op.f('ix_email_templates_name'), 'email_templates', ['name'], unique=True)
    op.create_table('webhook_subscriptions',
    sa.Column('id', app.db.types.GUID(), nullable=False),
    sa.Column('source', sa.String(length=50), nullable=False),
    sa.Column('source_company_id', sa.String(length=255), nullable=True),
    sa.Column('webhook_url', sa.Text(), nullable=False),
    sa.Column('webhook_secret', sa.String(length=512), nullable=True),
    sa.Column('event_types', sa.JSON(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('subscription_id', sa.String(length=255), nullable=True),
    sa.Column('verified', sa.Boolean(), nullable=True),
    sa.Column('verified_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('total_events_received', sa.Integer(), nullable=True),
    sa.Column('last_event_received_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('consecutive_failures', sa.Integer(), nullable=True),
    sa.Column('last_failure_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('last_failure_reason', sa.Text(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_webhook_subscriptions_source'), 'webhook_subscriptions', ['source'], unique=False)
    op.create_table('events_audit',
    sa.Column('id', app.db.types.GUID(), nullable=False),
    sa.Column('user_id', app.db.types.GUID(), nullable=True),
    sa.Column('event_type', sa.String(length=100), nullable=True),
    sa.Column('event_data', sa.JSON(), nullable=True),
    sa.Column('ip_address', sa.String(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_events_audit_event_type'), 'events_audit', ['event_type'], unique=False)
    op.create_index(op.f('ix_events_audit_user_id'), 'events_audit', ['user_id'], unique=False)
    op.create_table('interview_sessions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('interview_type', sa.String(length=50), nullable=False),
    sa.Column('role_level', sa.String(length=50), nullable=False),
    sa.Column('company_type', sa.String(length=50), nullable=False),
    sa.Column('focus_area', sa.String(length=100), nullable=True),
    sa.Column('target_company', sa.String(length=255), nullable=True),
    sa.Column('target_role', sa.String(length=255), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=True),
    sa.Column('total_questions', sa.Integer(), nullable=True),
    sa.Column('questions_answered', sa.Integer(), nullable=True),
    sa.Column('overall_score', sa.Float(), nullable=True),
    sa.Column('star_framework_score', sa.Float(), nullable=True),
    sa.Column('technical_accuracy_score', sa.Float(), nullable=True),
    sa.Column('communication_score', sa.Float(), nullable=True),
    sa.Column('confidence_score', sa.Float(), nullable=True),
    sa.Column('strengths', sa.JSON(), nullable=True),
    sa.Column('improvement_areas', sa.JSON(), nullable=True),
    sa.Column('feedback_summary', sa.Text(), nullable=True),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_interview_sessions_id'), 'interview_sessions', ['id'], unique=False)
    op.create_index(op.f('ix_interview_sessions_user_id'), 'interview_sessions', ['user_id'], unique=False)
    op.create_table('notification_preferences',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('email_job_matches', sa.Boolean(), nullable=True),
    sa.Column('email_application_updates', sa.Boolean(), nullable=True),
    sa.Column('email_interview_reminders', sa.Boolean(), nullable=True),
    sa.Column('email_credit_alerts', sa.Boolean(), nullable=True),
    sa.Column('email_weekly_digest', sa.Boolean(), nullable=True),
    sa.Column('email_marketing', sa.Boolean(), nullable=True),
    sa.Column('inapp_job_matches', sa.Boolean(), nullable=True),
    sa.Column('inapp_application_updates', sa.Boolean(), nullable=True),
    sa.Column('inapp_interview_reminders', sa.Boolean(), nullable=True),
    sa.Column('inapp_credit_alerts', sa.Boolean(), nullable=True),
    sa.Column('inapp_system_updates', sa.Boolean(), nullable=True),
    sa.Column('job_match_frequency', sa.String(length=20), nullable=True),
    sa.Column('digest_day', sa.String(length=10), nullable=True),
    sa.Column('quiet_hours_start', sa.Integer(), nullable=True),
    sa.Column('quiet_hours_end', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_notification_preferences_id'), 'notification_preferences', ['id'], unique=False)
    op.create_index(op.f('ix_notification_preferences_user_id'), 'notification_preferences', ['user_id'], unique=True)
    op.create_table('notifications',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('action_url', sa.String(length=500), nullable=True),
    sa.Column('priority', sa.String(length=20), nullable=True),
    sa.Column('category', sa.String(length=50), nullable=True),
    sa.Column('data', sa.JSON(), nullable=True),
    sa.Column('is_read', sa.Boolean(), nullable=True),
    sa.Column('is_archived', sa.Boolean(), nullable=True),
    sa.Column('read_at', sa.DateTime(), nullable=True),
    sa.Column('email_sent', sa.Boolean(), nullable=True),
    sa.Column('email_sent_at', sa.DateTime(), nullable=True),
    sa.Column('email_message_id', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_notifications_created_at'), 'notifications', ['created_at'], unique=False)
    op.create_index(op.f('ix_notifications_id'), 'notifications', ['id'], unique=False)
    op.create_index(op.f('ix_notifications_is_read'), 'notifications', ['is_read'], unique=False)
    op.create_index(op.f('ix_notifications_type'), 'notifications', ['type'], unique=False)
    op.create_index(op.f('ix_notifications_user_id'), 'notifications', ['user_id'], unique=False)
    op.create_table('auto_apply_configs',
    sa.Column('id', app.db.types.GUID(), nullable=False),
    sa.Column('user_id', app.db.types.GUID(), nullable=False),
    sa.Column('enabled', sa.Boolean(), nullable=False),
    sa.Column('mode', sa.String(length=50), nullable=False),
    sa.Column('min_fit_score', sa.Integer(), nullable=False),
    sa.Column('max_applications_per_day', sa.Integer(), nullable=False),
    sa.Column('max_applications_per_week', sa.Integer(), nullable=False),
    sa.Column('remote_only', sa.Boolean(), nullable=True),
    sa.Column('hybrid_allowed', sa.Boolean(), nullable=True),
    sa.Column('onsite_allowed', sa.Boolean(), nullable=True),
    sa.Column('min_salary', sa.Integer(), nullable=True),
    sa.Column('max_salary', sa.Integer(), nullable=True),
    sa.Column('preferred_locations', sa.JSON(), nullable=True),
    sa.Column('excluded_locations', sa.JSON(), nullable=True),
    sa.Column('preferred_companies', sa.JSON(), nullable=True),
    sa.Column('excluded_companies', sa.JSON(), nullable=True),
    sa.Column('employment_types', sa.JSON(), nullable=True),
    sa.Column('seniority_levels', sa.JSON(), nullable=True),
    sa.Column('use_default_resume', sa.Boolean(), nullable=True),
    sa.Column('default_resume_id', app.db.types.GUID(), nullable=True),
    sa.Column('auto_generate_cover_letter', sa.Boolean(), nullable=True),
    sa.Column('notify_on_apply', sa.Boolean(), nullable=True),
    sa.Column('notify_on_error', sa.Boolean(), nullable=True),
    sa.Column('notify_on_refund', sa.Boolean(), nullable=True),
    sa.Column('pause_until', sa.TIMESTAMP(), nullable=True),
    sa.Column('daily_application_count', sa.Integer(), nullable=True),
    sa.Column('weekly_application_count', sa.Integer(), nullable=True),
    sa.Column('last_daily_reset', sa.TIMESTAMP(), nullable=True),
    sa.Column('last_weekly_reset', sa.TIMESTAMP(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['default_resume_id'], ['resumes.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id')
    )
    op.create_table('interview_questions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.Integer(), nullable=False),
    sa.Column('question_number', sa.Integer(), nullable=False),
    sa.Column('question_text', sa.Text(), nullable=False),
    sa.Column('question_category', sa.String(length=100), nullable=True),
    sa.Column('difficulty_level', sa.String(length=50), nullable=True),
    sa.Column('user_answer', sa.Text(), nullable=True),
    sa.Column('time_taken_seconds', sa.Integer(), nullable=True),
    sa.Column('ai_feedback', sa.Text(), nullable=True),
    sa.Column('sample_answer', sa.Text(), nullable=True),
    sa.Column('score', sa.Float(), nullable=True),
    sa.Column('has_situation', sa.Boolean(), nullable=True),
    sa.Column('has_task', sa.Boolean(), nullable=True),
    sa.Column('has_action', sa.Boolean(), nullable=True),
    sa.Column('has_result', sa.Boolean(), nullable=True),
    sa.Column('star_completeness_score', sa.Float(), nullable=True),
    sa.Column('strengths', sa.JSON(), nullable=True),
    sa.Column('improvements', sa.JSON(), nullable=True),
    sa.Column('asked_at', sa.DateTime(), nullable=True),
    sa.Column('answered_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['session_id'], ['interview_sessions.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_interview_questions_id'), 'interview_questions', ['id'], unique=False)
    op.create_index(op.f('ix_interview_questions_session_id'), 'interview_questions', ['session_id'], unique=False)
    op.create_table('auto_apply_jobs',
    sa.Column('id', app.db.types.GUID(), nullable=False),
    sa.Column('user_id', app.db.types.GUID(), nullable=False),
    sa.Column('job_id', app.db.types.GUID(), nullable=False),
    sa.Column('application_id', app.db.types.GUID(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('priority', sa.Integer(), nullable=True),
    sa.Column('fit_score', sa.Float(), nullable=False),
    sa.Column('fit_rationale', sa.Text(), nullable=True),
    sa.Column('resume_version_id', app.db.types.GUID(), nullable=True),
    sa.Column('cover_letter_id', app.db.types.GUID(), nullable=True),
    sa.Column('job_source', sa.String(length=50), nullable=False),
    sa.Column('job_board_url', sa.Text(), nullable=False),
    sa.Column('application_url', sa.Text(), nullable=True),
    sa.Column('company_name', sa.String(length=255), nullable=True),
    sa.Column('scheduled_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('started_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('completed_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('attempts', sa.Integer(), nullable=True),
    sa.Column('max_attempts', sa.Integer(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('error_type', sa.String(length=50), nullable=True),
    sa.Column('last_error_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('credits_used', sa.Integer(), nullable=True),
    sa.Column('credits_refunded', sa.Boolean(), nullable=True),
    sa.Column('refund_reason', sa.String(length=255), nullable=True),
    sa.Column('refunded_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('form_data', sa.JSON(), nullable=True),
    sa.Column('submission_response', sa.JSON(), nullable=True),
    sa.Column('user_approved', sa.Boolean(), nullable=True),
    sa.Column('tos_compliant', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['application_id'], ['applications.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['cover_letter_id'], ['cover_letters.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['job_id'], ['jobs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['resume_version_id'], ['resume_versions.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_auto_apply_jobs_status'), 'auto_apply_jobs', ['status'], unique=False)
    op.create_index(op.f('ix_auto_apply_jobs_user_id'), 'auto_apply_jobs', ['user_id'], unique=False)
    op.create_table('webhook_events',
    sa.Column('id', app.db.types.GUID(), nullable=False),
    sa.Column('source', sa.String(length=50), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('event_id', sa.String(length=255), nullable=True),
    sa.Column('signature', sa.String(length=512), nullable=True),
    sa.Column('is_verified', sa.Boolean(), nullable=True),
    sa.Column('payload', sa.JSON(), nullable=False),
    sa.Column('headers', sa.JSON(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('processed_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('retry_count', sa.Integer(), nullable=True),
    sa.Column('max_retries', sa.Integer(), nullable=True),
    sa.Column('application_id', app.db.types.GUID(), nullable=True),
    sa.Column('user_id', app.db.types.GUID(), nullable=True),
    sa.Column('received_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['application_id'], ['applications.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_webhook_events_application_id'), 'webhook_events', ['application_id'], unique=False)
    op.create_index(op.f('ix_webhook_events_event_id'), 'webhook_events', ['event_id'], unique=False)
    op.create_index(op.f('ix_webhook_events_event_type'), 'webhook_events', ['event_type'], unique=False)
    op.create_index(op.f('ix_webhook_events_received_at'), 'webhook_events', ['received_at'], unique=False)
    op.create_index(op.f('ix_webhook_events_source'), 'webhook_events', ['source'], unique=False)
    op.create_index(op.f('ix_webhook_events_status'), 'webhook_events', ['status'], unique=False)
    op.create_index(op.f('ix_webhook_events_user_id'), 'webhook_events', ['user_id'], unique=False)
    op.create_table('application_status_history',
    sa.Column('id', app.db.types.GUID(), nullable=False),
    sa.Column('application_id', app.db.types.GUID(), nullable=False),
    sa.Column('old_status', sa.String(length=50), nullable=True),
    sa.Column('new_status', sa.String(length=50), nullable=False),
    sa.Column('changed_by', sa.String(length=50), nullable=True),
    sa.Column('change_reason', sa.Text(), nullable=True),
    sa.Column('webhook_event_id', app.db.types.GUID(), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('changed_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['application_id'], ['applications.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['webhook_event_id'], ['webhook_events.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_application_status_history_application_id'), 'application_status_history', ['application_id'], unique=False)
    op.create_index(op.f('ix_application_status_history_changed_at'), 'application_status_history', ['changed_at'], unique=False)
    op.create_index(op.f('ix_application_status_history_new_status'), 'application_status_history', ['new_status'], unique=False)
    op.drop_index('ix_email_verification_codes_email', table_name='email_verification_codes')
    op.drop_table('email_verification_codes')
    op.create_index(op.f('ix_analytics_snapshots_company_id'), 'analytics_snapshots', ['company_id'], unique=False)
    op.drop_index('ix_api_key_usage_api_key_id', table_name='api_key_usage')
    op.drop_index('ix_api_key_usage_company_id', table_name='api_key_usage')
    op.drop_index('ix_api_key_usage_created_at', table_name='api_key_usage')
    op.drop_index('ix_api_key_usage_endpoint', table_name='api_key_usage')
    op.drop_index('ix_api_key_usage_rate_limit', table_name='api_key_usage')
    op.drop_index('ix_api_keys_company_id', table_name='api_keys')
    op.drop_index('ix_api_keys_created_at', table_name='api_keys')
    op.drop_index('ix_api_keys_key_prefix', table_name='api_keys')
    op.drop_index('ix_api_keys_status', table_name='api_keys')
    op.alter_column('application_notes', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('application_notes', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_application_stage_history_application_id'), 'application_stage_history', ['application_id'], unique=False)
    op.create_index(op.f('ix_application_stage_history_changed_at'), 'application_stage_history', ['changed_at'], unique=False)
    op.add_column('applications', sa.Column('is_auto_applied', sa.Boolean(), nullable=True))
    op.add_column('applications', sa.Column('application_mode', sa.String(length=50), nullable=True))
    op.add_column('applications', sa.Column('external_id', sa.String(length=255), nullable=True))
    op.add_column('applications', sa.Column('external_source', sa.String(length=50), nullable=True))
    op.drop_index('idx_applications_source', table_name='applications')
    op.drop_index('idx_applications_user_applied', table_name='applications')
    op.drop_index('idx_applications_user_created', table_name='applications')
    op.drop_index('idx_applications_user_status', table_name='applications')
    op.drop_index('idx_applications_user_status_created', table_name='applications')
    op.drop_index('idx_applications_user_updated', table_name='applications')
    op.create_index(op.f('ix_applications_external_id'), 'applications', ['external_id'], unique=False)
    op.create_index(op.f('ix_applications_external_source'), 'applications', ['external_source'], unique=False)
    op.create_index(op.f('ix_applications_source'), 'applications', ['source'], unique=False)
    op.alter_column('assessment_attempts', 'auto_submitted',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_attempts', 'questions_answered',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_attempts', 'questions_correct',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_attempts', 'tab_switch_count',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_attempts', 'grading_status',
               existing_type=sa.VARCHAR(length=50),
               nullable=False,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('assessment_questions', 'execution_timeout_seconds',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('10'))
    op.alter_column('assessment_questions', 'max_file_size_mb',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('10'))
    op.alter_column('assessment_questions', 'is_required',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('assessment_questions', 'allow_partial_credit',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('assessment_responses', 'auto_graded',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_responses', 'flagged_for_review',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_responses', 'copy_paste_detected',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_responses', 'answer_changed_count',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('assessments', 'passing_score_percentage',
               existing_type=sa.NUMERIC(precision=5, scale=2),
               nullable=False,
               existing_server_default=sa.text('70.00'))
    op.alter_column('assessments', 'max_attempts',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('1'))
    op.alter_column('assessments', 'randomize_questions',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'randomize_options',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'show_correct_answers',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'show_results_immediately',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('assessments', 'enable_proctoring',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'allow_tab_switching',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('assessments', 'max_tab_switches',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('5'))
    op.alter_column('assessments', 'require_webcam',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'track_ip_address',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('assessments', 'total_attempts',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('assessments', 'total_completions',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('bulk_job_uploads', 'raw_jobs_data',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'enriched_jobs_data',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'validation_errors',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'duplicate_info',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'distribution_channels',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('bulk_job_uploads', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('candidate_availability', 'available_slots',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=False)
    op.alter_column('candidate_availability', 'timezone',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=50),
               existing_nullable=False)
    op.alter_column('candidate_availability', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('candidate_availability', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_candidate_availability_application_id', table_name='candidate_availability')
    op.drop_index('idx_candidate_availability_candidate_id', table_name='candidate_availability')
    op.drop_index('idx_candidate_availability_expires_at', table_name='candidate_availability')
    op.create_index(op.f('ix_candidate_availability_application_id'), 'candidate_availability', ['application_id'], unique=False)
    op.create_index(op.f('ix_candidate_availability_candidate_id'), 'candidate_availability', ['candidate_id'], unique=False)
    op.drop_column('candidate_availability', 'requested_at')
    op.alter_column('candidate_profiles', 'skills',
               existing_type=postgresql.ARRAY(sa.VARCHAR(length=100)),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('candidate_profiles', 'preferred_roles',
               existing_type=postgresql.ARRAY(sa.VARCHAR(length=100)),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('candidate_profiles', 'portfolio',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True,
               existing_server_default=sa.text("'[]'::jsonb"))
    op.drop_constraint('candidate_profiles_user_id_key', 'candidate_profiles', type_='unique')
    op.drop_index('ix_candidate_profiles_experience_level', table_name='candidate_profiles')
    op.drop_index('ix_candidate_profiles_location', table_name='candidate_profiles')
    op.drop_index('ix_candidate_profiles_open_to_work', table_name='candidate_profiles')
    op.drop_index('ix_candidate_profiles_skills', table_name='candidate_profiles', postgresql_using='gin')
    op.drop_index('ix_candidate_profiles_visibility', table_name='candidate_profiles')
    op.create_index(op.f('ix_candidate_profiles_id'), 'candidate_profiles', ['id'], unique=False)
    op.add_column('candidate_views', sa.Column('candidate_profile_id', app.db.types.GUID(), nullable=False))
    op.drop_index('ix_candidate_views_company_created', table_name='candidate_views')
    op.create_index(op.f('ix_candidate_views_id'), 'candidate_views', ['id'], unique=False)
    op.create_foreign_key(None, 'candidate_views', 'candidate_profiles', ['candidate_profile_id'], ['id'], ondelete='CASCADE')
    op.alter_column('companies', 'max_active_jobs',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('1'))
    op.alter_column('companies', 'max_candidate_views',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('10'))
    op.alter_column('companies', 'max_team_members',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('1'))
    op.drop_index('idx_companies_domain', table_name='companies')
    op.drop_index('idx_companies_subscription_tier', table_name='companies')
    op.drop_constraint('fk_companies_default_job_template_id', 'companies', type_='foreignkey')
    op.drop_constraint('company_analytics_config_company_id_key', 'company_analytics_config', type_='unique')
    op.create_index(op.f('ix_company_analytics_config_company_id'), 'company_analytics_config', ['company_id'], unique=True)
    op.alter_column('company_members', 'status',
               existing_type=sa.VARCHAR(length=50),
               nullable=True,
               existing_server_default=sa.text("'active'::character varying"))
    op.alter_column('company_members', 'notification_preferences',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::jsonb"))
    op.drop_index('idx_company_members_company', table_name='company_members')
    op.drop_index('idx_company_members_role', table_name='company_members')
    op.drop_index('idx_company_members_user', table_name='company_members')
    op.drop_constraint('uq_company_member', 'company_members', type_='unique')
    op.alter_column('company_subscriptions', 'cancel_at_period_end',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('company_subscriptions', 'jobs_posted_this_month',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('company_subscriptions', 'candidate_views_this_month',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.drop_index('idx_company_subscriptions_company', table_name='company_subscriptions')
    op.drop_index('idx_company_subscriptions_stripe', table_name='company_subscriptions')
    op.drop_index('idx_cover_letters_user_created', table_name='cover_letters')
    op.create_foreign_key(None, 'cover_letters', 'cover_letters', ['parent_id'], ['id'], ondelete='SET NULL')
    op.add_column('credit_ledger', sa.Column('credit_type', sa.String(length=50), nullable=True))
    op.add_column('credit_ledger', sa.Column('balance_after', sa.Integer(), nullable=True))
    op.add_column('credit_ledger', sa.Column('operation', sa.String(length=50), nullable=True))
    op.add_column('credit_ledger', sa.Column('description', sa.Text(), nullable=True))
    op.add_column('credit_ledger', sa.Column('reference_id', app.db.types.GUID(), nullable=True))
    op.add_column('credit_ledger', sa.Column('stripe_payment_intent_id', sa.String(length=255), nullable=True))
    op.drop_constraint('credit_ledger_application_id_fkey', 'credit_ledger', type_='foreignkey')
    op.drop_column('credit_ledger', 'transaction_type')
    op.drop_column('credit_ledger', 'reason')
    op.drop_column('credit_ledger', 'application_id')
    op.drop_constraint('credit_wallets_user_id_key', 'credit_wallets', type_='unique')
    op.drop_index('ix_credit_wallets_user_id', table_name='credit_wallets')
    op.create_index(op.f('ix_credit_wallets_user_id'), 'credit_wallets', ['user_id'], unique=True)
    op.alter_column('interview_feedback', 'interviewer_id',
               existing_type=sa.UUID(),
               nullable=False)
    op.alter_column('interview_feedback', 'strengths',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_feedback', 'concerns',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_feedback', 'is_submitted',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('interview_feedback', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('interview_feedback', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_interview_feedback_application_id', table_name='interview_feedback')
    op.drop_index('idx_interview_feedback_interview_id', table_name='interview_feedback')
    op.drop_index('idx_interview_feedback_interviewer_id', table_name='interview_feedback')
    op.drop_index('idx_interview_feedback_submitted', table_name='interview_feedback')
    op.create_index(op.f('ix_interview_feedback_application_id'), 'interview_feedback', ['application_id'], unique=False)
    op.create_index(op.f('ix_interview_feedback_interview_id'), 'interview_feedback', ['interview_id'], unique=False)
    op.create_index(op.f('ix_interview_feedback_interviewer_id'), 'interview_feedback', ['interviewer_id'], unique=False)
    op.drop_constraint('interview_feedback_interviewer_id_fkey', 'interview_feedback', type_='foreignkey')
    op.create_foreign_key(None, 'interview_feedback', 'company_members', ['interviewer_id'], ['id'], ondelete='CASCADE')
    op.alter_column('interview_schedules', 'interviewer_names',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'interviewer_emails',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'interviewer_ids',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'reminders_config',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'extra_data',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('interview_schedules', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_interview_schedules_application_id', table_name='interview_schedules')
    op.drop_index('idx_interview_schedules_scheduled_at', table_name='interview_schedules')
    op.drop_index('idx_interview_schedules_status', table_name='interview_schedules')
    op.drop_index('idx_interview_schedules_user_id', table_name='interview_schedules')
    op.create_foreign_key(None, 'interview_schedules', 'webhook_events', ['webhook_event_id'], ['id'], ondelete='SET NULL')
    op.drop_column('interview_schedules', 'candidate_showed_up')
    op.alter_column('job_assessment_requirements', 'is_required',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('job_assessment_requirements', 'must_pass_to_proceed',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('job_assessment_requirements', 'show_before_application',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('job_assessment_requirements', 'trigger_point',
               existing_type=sa.VARCHAR(length=50),
               nullable=False,
               existing_server_default=sa.text("'after_application'::character varying"))
    op.alter_column('job_distributions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_distributions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_index('ix_job_distributions_job_channel', table_name='job_distributions')
    op.alter_column('job_templates', 'requirements',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('job_templates', 'responsibilities',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('job_templates', 'skills',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('job_templates', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_templates', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_table_comment(
        'job_templates',
        existing_comment='Reusable job description templates for employers. Supports public templates (available to all) and private templates (company-specific).',
        schema=None
    )
    op.add_column('jobs', sa.Column('posted_date', sa.TIMESTAMP(), nullable=True))
    op.alter_column('jobs', 'source',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=50),
               existing_nullable=True)
    op.alter_column('jobs', 'title',
               existing_type=sa.VARCHAR(length=255),
               nullable=True)
    op.alter_column('jobs', 'company',
               existing_type=sa.VARCHAR(length=255),
               nullable=True)
    op.alter_column('jobs', 'required_skills',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True,
               existing_server_default=sa.text("'[]'::text"))
    op.alter_column('jobs', 'preferred_skills',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True,
               existing_server_default=sa.text("'[]'::text"))
    op.alter_column('jobs', 'external_url',
               existing_type=sa.VARCHAR(length=500),
               type_=sa.Text(),
               existing_nullable=True)
    op.drop_index('idx_jobs_posted_at', table_name='jobs')
    op.create_index(op.f('ix_jobs_title'), 'jobs', ['title'], unique=False)
    op.drop_column('jobs', 'remote_policy')
    op.drop_column('jobs', 'visa_friendly')
    op.drop_column('jobs', 'posted_at')
    op.drop_index('idx_match_scores_user_created', table_name='match_scores')
    op.drop_index('idx_match_scores_user_fit_index', table_name='match_scores')
    op.add_column('profiles', sa.Column('years_experience', sa.Integer(), nullable=True))
    op.add_column('profiles', sa.Column('expected_salary_min', sa.Integer(), nullable=True))
    op.add_column('profiles', sa.Column('expected_salary_max', sa.Integer(), nullable=True))
    op.add_column('profiles', sa.Column('availability_status', sa.String(length=50), nullable=True))
    op.add_column('profiles', sa.Column('preferred_location_type', sa.String(length=50), nullable=True))
    op.alter_column('question_bank', 'points',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('10'))
    op.alter_column('question_bank', 'is_public',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('question_bank', 'is_verified',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('question_bank', 'times_used',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('stripe_webhook_events', 'stripe_event_id',
               existing_type=sa.VARCHAR(length=255),
               nullable=True)
    op.drop_constraint('stripe_webhook_events_stripe_event_id_key', 'stripe_webhook_events', type_='unique')
    op.drop_index('ix_stripe_webhook_events_stripe_event_id', table_name='stripe_webhook_events')
    op.create_index(op.f('ix_stripe_webhook_events_stripe_event_id'), 'stripe_webhook_events', ['stripe_event_id'], unique=True)
    op.add_column('subscriptions', sa.Column('stripe_customer_id', sa.String(length=255), nullable=True))
    op.add_column('subscriptions', sa.Column('stripe_price_id', sa.String(length=255), nullable=True))
    op.add_column('subscriptions', sa.Column('billing_interval', sa.String(length=20), nullable=True))
    op.add_column('subscriptions', sa.Column('trial_start', sa.TIMESTAMP(), nullable=True))
    op.add_column('subscriptions', sa.Column('trial_end', sa.TIMESTAMP(), nullable=True))
    op.add_column('subscriptions', sa.Column('cancel_at_period_end', sa.Boolean(), nullable=True))
    op.add_column('subscriptions', sa.Column('canceled_at', sa.TIMESTAMP(), nullable=True))
    op.add_column('subscriptions', sa.Column('cancellation_reason', sa.Text(), nullable=True))
    op.alter_column('team_activities', 'action_type',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=50),
               existing_nullable=False)
    op.alter_column('team_activities', 'activity_metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('team_activities', 'mentioned_members',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.drop_index('idx_team_activities_action_type', table_name='team_activities')
    op.drop_index('idx_team_activities_company_id', table_name='team_activities')
    op.drop_index('idx_team_activities_created_at', table_name='team_activities')
    op.drop_index('idx_team_activities_entity', table_name='team_activities')
    op.drop_index('idx_team_activities_member_id', table_name='team_activities')
    op.alter_column('team_invitations', 'invited_by',
               existing_type=sa.UUID(),
               nullable=False)
    op.drop_index('idx_team_invitations_company_id', table_name='team_invitations')
    op.drop_index('idx_team_invitations_email', table_name='team_invitations')
    op.drop_index('idx_team_invitations_expires_at', table_name='team_invitations')
    op.drop_index('idx_team_invitations_status', table_name='team_invitations')
    op.drop_index('idx_team_invitations_token', table_name='team_invitations')
    op.drop_constraint('team_invitations_invited_by_fkey', 'team_invitations', type_='foreignkey')
    op.create_foreign_key(None, 'team_invitations', 'users', ['invited_by'], ['id'], ondelete='CASCADE')
    op.add_column('team_mentions', sa.Column('mentioned_by_member_id', app.db.types.GUID(), nullable=False))
    op.add_column('team_mentions', sa.Column('notified', sa.Boolean(), nullable=False))
    op.drop_index('idx_team_mentions_activity_id', table_name='team_mentions')
    op.drop_index('idx_team_mentions_mentioned_member_id', table_name='team_mentions')
    op.drop_index('idx_team_mentions_read', table_name='team_mentions')
    op.create_foreign_key(None, 'team_mentions', 'company_members', ['mentioned_by_member_id'], ['id'], ondelete='CASCADE')
    op.drop_column('team_mentions', 'read')
    op.add_column('users', sa.Column('password_hash', sa.String(length=255), nullable=True))
    op.add_column('users', sa.Column('oauth_id', sa.String(length=255), nullable=True))
    op.add_column('users', sa.Column('email_verified', sa.Boolean(), nullable=True))
    op.alter_column('users', 'user_type',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=50),
               comment=None,
               existing_comment='User account type: job_seeker or employer',
               existing_nullable=False,
               existing_server_default=sa.text("'job_seeker'::character varying"))
    op.drop_index('idx_users_user_type', table_name='users')
    op.drop_index('ix_users_id', table_name='users')
    op.drop_index('ix_users_oauth_provider_id', table_name='users')
    op.create_index(op.f('ix_users_user_type'), 'users', ['user_type'], unique=False)
    op.drop_column('users', 'remote_preference')
    op.drop_column('users', 'location')
    op.drop_column('users', 'is_verified')
    op.drop_column('users', 'portfolio_url')
    op.drop_column('users', 'github_url')
    op.drop_column('users', 'terms_accepted_at')
    op.drop_column('users', 'visa_sponsorship_required')
    op.drop_column('users', 'credit_balance')
    op.drop_column('users', 'reset_token_expires')
    op.drop_column('users', 'stripe_customer_id')
    op.drop_column('users', 'monthly_cover_letter_limit')
    op.drop_column('users', 'subscription_status')
    op.drop_column('users', 'hashed_password')
    op.drop_column('users', 'target_salary_min')
    op.drop_column('users', 'reset_token')
    op.drop_column('users', 'name')
    op.drop_column('users', 'linkedin_url')
    op.drop_column('users', 'last_login_at')
    op.drop_column('users', 'is_active')
    op.drop_column('users', 'phone')
    op.drop_column('users', 'monthly_job_suggestions_limit')
    op.drop_column('users', 'oauth_picture')
    op.drop_column('users', 'privacy_policy_accepted_at')
    op.drop_column('users', 'target_salary_max')
    op.drop_column('users', 'verification_token_expires')
    op.drop_column('users', 'marketing_emails_opt_in')
    op.drop_column('users', 'target_job_titles')
    op.drop_column('users', 'verification_token')
    op.drop_column('users', 'subscription_plan')
    op.drop_column('users', 'stripe_subscription_id')
    op.drop_column('users', 'oauth_provider_id')
    op.drop_index('ix_webhook_deliveries_company_id', table_name='webhook_deliveries')
    op.drop_index('ix_webhook_deliveries_created_at', table_name='webhook_deliveries')
    op.drop_index('ix_webhook_deliveries_event_type', table_name='webhook_deliveries')
    op.drop_index('ix_webhook_deliveries_next_retry_at', table_name='webhook_deliveries')
    op.drop_index('ix_webhook_deliveries_status', table_name='webhook_deliveries')
    op.drop_index('ix_webhook_deliveries_webhook_id', table_name='webhook_deliveries')
    op.drop_index('ix_webhooks_company_id', table_name='webhooks')
    op.drop_index('ix_webhooks_is_active', table_name='webhooks')
    op.alter_column('white_label_application_fields', 'field_name',
               existing_type=sa.VARCHAR(length=100),
               comment='e.g., "diversity_statement"',
               existing_nullable=False)
    op.alter_column('white_label_application_fields', 'field_label',
               existing_type=sa.VARCHAR(length=255),
               comment='e.g., "Diversity Statement"',
               existing_nullable=False)
    op.alter_column('white_label_application_fields', 'field_type',
               existing_type=sa.VARCHAR(length=50),
               comment='"text", "textarea", "select", "checkbox", "file"',
               existing_nullable=False)
    op.alter_column('white_label_application_fields', 'field_options',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='For select/radio: ["Option 1", "Option 2"]',
               existing_nullable=True)
    op.alter_column('white_label_application_fields', 'help_text',
               existing_type=sa.TEXT(),
               comment='Instruction text for applicants',
               existing_nullable=True)
    op.alter_column('white_label_application_fields', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_white_label_fields_active', table_name='white_label_application_fields')
    op.drop_index('idx_white_label_fields_company', table_name='white_label_application_fields')
    op.drop_index('idx_white_label_fields_display_order', table_name='white_label_application_fields')
    op.alter_column('white_label_branding', 'enabled_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=True)
    op.alter_column('white_label_branding', 'company_display_name',
               existing_type=sa.VARCHAR(length=255),
               comment='Custom display name (can differ from company.name)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_url',
               existing_type=sa.VARCHAR(length=500),
               comment='Primary logo (light background)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_dark_url',
               existing_type=sa.VARCHAR(length=500),
               comment='Logo for dark backgrounds',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_icon_url',
               existing_type=sa.VARCHAR(length=500),
               comment='Icon/favicon (512x512)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_email_url',
               existing_type=sa.VARCHAR(length=500),
               comment='Email header logo (600x200)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'custom_domain',
               existing_type=sa.VARCHAR(length=255),
               comment='e.g., careers.company.com',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'social_links',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='{"linkedin": "url", "twitter": "url"}',
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::jsonb"))
    op.alter_column('white_label_branding', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('white_label_branding', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_white_label_branding_company', table_name='white_label_branding')
    op.drop_index('idx_white_label_branding_custom_domain', table_name='white_label_branding')
    op.drop_index('idx_white_label_branding_enabled', table_name='white_label_branding')
    op.alter_column('white_label_domain_verification', 'verification_method',
               existing_type=sa.VARCHAR(length=50),
               comment='"dns_txt", "dns_cname", "file_upload"',
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment='"pending", "verified", "failed"',
               existing_nullable=False,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('white_label_domain_verification', 'verified_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'last_check_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'dns_records',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Required DNS records to add',
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_white_label_domain_company', table_name='white_label_domain_verification')
    op.drop_index('idx_white_label_domain_domain', table_name='white_label_domain_verification')
    op.drop_index('idx_white_label_domain_status', table_name='white_label_domain_verification')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_index('idx_white_label_domain_status', 'white_label_domain_verification', ['status'], unique=False)
    op.create_index('idx_white_label_domain_domain', 'white_label_domain_verification', ['domain'], unique=False)
    op.create_index('idx_white_label_domain_company', 'white_label_domain_verification', ['company_id'], unique=False)
    op.alter_column('white_label_domain_verification', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('white_label_domain_verification', 'dns_records',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='Required DNS records to add',
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'last_check_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'verified_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=True)
    op.alter_column('white_label_domain_verification', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='"pending", "verified", "failed"',
               existing_nullable=False,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('white_label_domain_verification', 'verification_method',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='"dns_txt", "dns_cname", "file_upload"',
               existing_nullable=True)
    op.create_index('idx_white_label_branding_enabled', 'white_label_branding', ['is_enabled'], unique=False)
    op.create_index('idx_white_label_branding_custom_domain', 'white_label_branding', ['custom_domain'], unique=False)
    op.create_index('idx_white_label_branding_company', 'white_label_branding', ['company_id'], unique=False)
    op.alter_column('white_label_branding', 'updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('white_label_branding', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('white_label_branding', 'social_links',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='{"linkedin": "url", "twitter": "url"}',
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::jsonb"))
    op.alter_column('white_label_branding', 'custom_domain',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='e.g., careers.company.com',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_email_url',
               existing_type=sa.VARCHAR(length=500),
               comment=None,
               existing_comment='Email header logo (600x200)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_icon_url',
               existing_type=sa.VARCHAR(length=500),
               comment=None,
               existing_comment='Icon/favicon (512x512)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_dark_url',
               existing_type=sa.VARCHAR(length=500),
               comment=None,
               existing_comment='Logo for dark backgrounds',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'logo_url',
               existing_type=sa.VARCHAR(length=500),
               comment=None,
               existing_comment='Primary logo (light background)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'company_display_name',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='Custom display name (can differ from company.name)',
               existing_nullable=True)
    op.alter_column('white_label_branding', 'enabled_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=True)
    op.create_index('idx_white_label_fields_display_order', 'white_label_application_fields', ['company_id', 'display_order'], unique=False)
    op.create_index('idx_white_label_fields_company', 'white_label_application_fields', ['company_id'], unique=False)
    op.create_index('idx_white_label_fields_active', 'white_label_application_fields', ['is_active'], unique=False)
    op.alter_column('white_label_application_fields', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('white_label_application_fields', 'help_text',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='Instruction text for applicants',
               existing_nullable=True)
    op.alter_column('white_label_application_fields', 'field_options',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='For select/radio: ["Option 1", "Option 2"]',
               existing_nullable=True)
    op.alter_column('white_label_application_fields', 'field_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='"text", "textarea", "select", "checkbox", "file"',
               existing_nullable=False)
    op.alter_column('white_label_application_fields', 'field_label',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='e.g., "Diversity Statement"',
               existing_nullable=False)
    op.alter_column('white_label_application_fields', 'field_name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='e.g., "diversity_statement"',
               existing_nullable=False)
    op.create_index('ix_webhooks_is_active', 'webhooks', ['is_active'], unique=False)
    op.create_index('ix_webhooks_company_id', 'webhooks', ['company_id'], unique=False)
    op.create_index('ix_webhook_deliveries_webhook_id', 'webhook_deliveries', ['webhook_id'], unique=False)
    op.create_index('ix_webhook_deliveries_status', 'webhook_deliveries', ['status'], unique=False)
    op.create_index('ix_webhook_deliveries_next_retry_at', 'webhook_deliveries', ['next_retry_at'], unique=False)
    op.create_index('ix_webhook_deliveries_event_type', 'webhook_deliveries', ['event_type'], unique=False)
    op.create_index('ix_webhook_deliveries_created_at', 'webhook_deliveries', ['created_at'], unique=False)
    op.create_index('ix_webhook_deliveries_company_id', 'webhook_deliveries', ['company_id'], unique=False)
    op.add_column('users', sa.Column('oauth_provider_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('stripe_subscription_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('subscription_plan', sa.VARCHAR(length=50), server_default=sa.text("'free'::character varying"), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('verification_token', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('target_job_titles', sa.TEXT(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('marketing_emails_opt_in', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('verification_token_expires', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('target_salary_max', sa.INTEGER(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('privacy_policy_accepted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('oauth_picture', sa.VARCHAR(length=500), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('monthly_job_suggestions_limit', sa.INTEGER(), server_default=sa.text('10'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('phone', sa.VARCHAR(length=20), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('last_login_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('linkedin_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False))
    op.add_column('users', sa.Column('reset_token', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('target_salary_min', sa.INTEGER(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('hashed_password', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('subscription_status', sa.VARCHAR(length=50), server_default=sa.text("'active'::character varying"), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('monthly_cover_letter_limit', sa.INTEGER(), server_default=sa.text('3'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('stripe_customer_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('reset_token_expires', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('credit_balance', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('visa_sponsorship_required', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('terms_accepted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('github_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('portfolio_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('is_verified', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('location', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('remote_preference', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
    op.drop_index(op.f('ix_users_user_type'), table_name='users')
    op.create_index('ix_users_oauth_provider_id', 'users', ['oauth_provider_id'], unique=False)
    op.create_index('ix_users_id', 'users', ['id'], unique=False)
    op.create_index('idx_users_user_type', 'users', ['user_type'], unique=False)
    op.alter_column('users', 'user_type',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=20),
               comment='User account type: job_seeker or employer',
               existing_nullable=False,
               existing_server_default=sa.text("'job_seeker'::character varying"))
    op.drop_column('users', 'email_verified')
    op.drop_column('users', 'oauth_id')
    op.drop_column('users', 'password_hash')
    op.add_column('team_mentions', sa.Column('read', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'team_mentions', type_='foreignkey')
    op.create_index('idx_team_mentions_read', 'team_mentions', ['read'], unique=False)
    op.create_index('idx_team_mentions_mentioned_member_id', 'team_mentions', ['mentioned_member_id'], unique=False)
    op.create_index('idx_team_mentions_activity_id', 'team_mentions', ['activity_id'], unique=False)
    op.drop_column('team_mentions', 'notified')
    op.drop_column('team_mentions', 'mentioned_by_member_id')
    op.drop_constraint(None, 'team_invitations', type_='foreignkey')
    op.create_foreign_key('team_invitations_invited_by_fkey', 'team_invitations', 'company_members', ['invited_by'], ['id'], ondelete='SET NULL')
    op.create_index('idx_team_invitations_token', 'team_invitations', ['invitation_token'], unique=False)
    op.create_index('idx_team_invitations_status', 'team_invitations', ['status'], unique=False)
    op.create_index('idx_team_invitations_expires_at', 'team_invitations', ['expires_at'], unique=False)
    op.create_index('idx_team_invitations_email', 'team_invitations', ['email'], unique=False)
    op.create_index('idx_team_invitations_company_id', 'team_invitations', ['company_id'], unique=False)
    op.alter_column('team_invitations', 'invited_by',
               existing_type=sa.UUID(),
               nullable=True)
    op.create_index('idx_team_activities_member_id', 'team_activities', ['member_id'], unique=False)
    op.create_index('idx_team_activities_entity', 'team_activities', ['entity_type', 'entity_id'], unique=False)
    op.create_index('idx_team_activities_created_at', 'team_activities', ['created_at'], unique=False)
    op.create_index('idx_team_activities_company_id', 'team_activities', ['company_id'], unique=False)
    op.create_index('idx_team_activities_action_type', 'team_activities', ['action_type'], unique=False)
    op.alter_column('team_activities', 'mentioned_members',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('team_activities', 'activity_metadata',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('team_activities', 'action_type',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=100),
               existing_nullable=False)
    op.drop_column('subscriptions', 'cancellation_reason')
    op.drop_column('subscriptions', 'canceled_at')
    op.drop_column('subscriptions', 'cancel_at_period_end')
    op.drop_column('subscriptions', 'trial_end')
    op.drop_column('subscriptions', 'trial_start')
    op.drop_column('subscriptions', 'billing_interval')
    op.drop_column('subscriptions', 'stripe_price_id')
    op.drop_column('subscriptions', 'stripe_customer_id')
    op.drop_index(op.f('ix_stripe_webhook_events_stripe_event_id'), table_name='stripe_webhook_events')
    op.create_index('ix_stripe_webhook_events_stripe_event_id', 'stripe_webhook_events', ['stripe_event_id'], unique=False)
    op.create_unique_constraint('stripe_webhook_events_stripe_event_id_key', 'stripe_webhook_events', ['stripe_event_id'])
    op.alter_column('stripe_webhook_events', 'stripe_event_id',
               existing_type=sa.VARCHAR(length=255),
               nullable=False)
    op.alter_column('question_bank', 'times_used',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('question_bank', 'is_verified',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('question_bank', 'is_public',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('question_bank', 'points',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('10'))
    op.drop_column('profiles', 'preferred_location_type')
    op.drop_column('profiles', 'availability_status')
    op.drop_column('profiles', 'expected_salary_max')
    op.drop_column('profiles', 'expected_salary_min')
    op.drop_column('profiles', 'years_experience')
    op.create_index('idx_match_scores_user_fit_index', 'match_scores', ['user_id', 'fit_index'], unique=False)
    op.create_index('idx_match_scores_user_created', 'match_scores', ['user_id', 'created_at'], unique=False)
    op.add_column('jobs', sa.Column('posted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('jobs', sa.Column('visa_friendly', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('jobs', sa.Column('remote_policy', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
    op.drop_index(op.f('ix_jobs_title'), table_name='jobs')
    op.create_index('idx_jobs_posted_at', 'jobs', ['posted_at'], unique=False)
    op.alter_column('jobs', 'external_url',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(length=500),
               existing_nullable=True)
    op.alter_column('jobs', 'preferred_skills',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True,
               existing_server_default=sa.text("'[]'::text"))
    op.alter_column('jobs', 'required_skills',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True,
               existing_server_default=sa.text("'[]'::text"))
    op.alter_column('jobs', 'company',
               existing_type=sa.VARCHAR(length=255),
               nullable=False)
    op.alter_column('jobs', 'title',
               existing_type=sa.VARCHAR(length=255),
               nullable=False)
    op.alter_column('jobs', 'source',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=100),
               existing_nullable=True)
    op.drop_column('jobs', 'posted_date')
    op.create_table_comment(
        'job_templates',
        'Reusable job description templates for employers. Supports public templates (available to all) and private templates (company-specific).',
        existing_comment=None,
        schema=None
    )
    op.alter_column('job_templates', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_templates', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_templates', 'skills',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('job_templates', 'responsibilities',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('job_templates', 'requirements',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.create_index('ix_job_distributions_job_channel', 'job_distributions', ['job_id', 'channel'], unique=False)
    op.alter_column('job_distributions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_distributions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_assessment_requirements', 'trigger_point',
               existing_type=sa.VARCHAR(length=50),
               nullable=True,
               existing_server_default=sa.text("'after_application'::character varying"))
    op.alter_column('job_assessment_requirements', 'show_before_application',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.alter_column('job_assessment_requirements', 'must_pass_to_proceed',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('job_assessment_requirements', 'is_required',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.add_column('interview_schedules', sa.Column('candidate_showed_up', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'interview_schedules', type_='foreignkey')
    op.create_index('idx_interview_schedules_user_id', 'interview_schedules', ['user_id'], unique=False)
    op.create_index('idx_interview_schedules_status', 'interview_schedules', ['status'], unique=False)
    op.create_index('idx_interview_schedules_scheduled_at', 'interview_schedules', ['scheduled_at'], unique=False)
    op.create_index('idx_interview_schedules_application_id', 'interview_schedules', ['application_id'], unique=False)
    op.alter_column('interview_schedules', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('interview_schedules', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('interview_schedules', 'extra_data',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'reminders_config',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'interviewer_ids',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'interviewer_emails',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('interview_schedules', 'interviewer_names',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.drop_constraint(None, 'interview_feedback', type_='foreignkey')
    op.create_foreign_key('interview_feedback_interviewer_id_fkey', 'interview_feedback', 'company_members', ['interviewer_id'], ['id'], ondelete='SET NULL')
    op.drop_index(op.f('ix_interview_feedback_interviewer_id'), table_name='interview_feedback')
    op.drop_index(op.f('ix_interview_feedback_interview_id'), table_name='interview_feedback')
    op.drop_index(op.f('ix_interview_feedback_application_id'), table_name='interview_feedback')
    op.create_index('idx_interview_feedback_submitted', 'interview_feedback', ['is_submitted'], unique=False)
    op.create_index('idx_interview_feedback_interviewer_id', 'interview_feedback', ['interviewer_id'], unique=False)
    op.create_index('idx_interview_feedback_interview_id', 'interview_feedback', ['interview_id'], unique=False)
    op.create_index('idx_interview_feedback_application_id', 'interview_feedback', ['application_id'], unique=False)
    op.alter_column('interview_feedback', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('interview_feedback', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('interview_feedback', 'is_submitted',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('interview_feedback', 'concerns',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('interview_feedback', 'strengths',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('interview_feedback', 'interviewer_id',
               existing_type=sa.UUID(),
               nullable=True)
    op.drop_index(op.f('ix_credit_wallets_user_id'), table_name='credit_wallets')
    op.create_index('ix_credit_wallets_user_id', 'credit_wallets', ['user_id'], unique=False)
    op.create_unique_constraint('credit_wallets_user_id_key', 'credit_wallets', ['user_id'])
    op.add_column('credit_ledger', sa.Column('application_id', sa.UUID(), autoincrement=False, nullable=True))
    op.add_column('credit_ledger', sa.Column('reason', sa.TEXT(), autoincrement=False, nullable=True))
    op.add_column('credit_ledger', sa.Column('transaction_type', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
    op.create_foreign_key('credit_ledger_application_id_fkey', 'credit_ledger', 'applications', ['application_id'], ['id'], ondelete='SET NULL')
    op.drop_column('credit_ledger', 'stripe_payment_intent_id')
    op.drop_column('credit_ledger', 'reference_id')
    op.drop_column('credit_ledger', 'description')
    op.drop_column('credit_ledger', 'operation')
    op.drop_column('credit_ledger', 'balance_after')
    op.drop_column('credit_ledger', 'credit_type')
    op.drop_constraint(None, 'cover_letters', type_='foreignkey')
    op.create_index('idx_cover_letters_user_created', 'cover_letters', ['user_id', 'created_at'], unique=False)
    op.create_index('idx_company_subscriptions_stripe', 'company_subscriptions', ['stripe_subscription_id'], unique=False)
    op.create_index('idx_company_subscriptions_company', 'company_subscriptions', ['company_id'], unique=False)
    op.alter_column('company_subscriptions', 'candidate_views_this_month',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('company_subscriptions', 'jobs_posted_this_month',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('company_subscriptions', 'cancel_at_period_end',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.create_unique_constraint('uq_company_member', 'company_members', ['company_id', 'user_id'])
    op.create_index('idx_company_members_user', 'company_members', ['user_id'], unique=False)
    op.create_index('idx_company_members_role', 'company_members', ['role'], unique=False)
    op.create_index('idx_company_members_company', 'company_members', ['company_id'], unique=False)
    op.alter_column('company_members', 'notification_preferences',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::jsonb"))
    op.alter_column('company_members', 'status',
               existing_type=sa.VARCHAR(length=50),
               nullable=False,
               existing_server_default=sa.text("'active'::character varying"))
    op.drop_index(op.f('ix_company_analytics_config_company_id'), table_name='company_analytics_config')
    op.create_unique_constraint('company_analytics_config_company_id_key', 'company_analytics_config', ['company_id'])
    op.create_foreign_key('fk_companies_default_job_template_id', 'companies', 'job_templates', ['default_job_template_id'], ['id'], ondelete='SET NULL')
    op.create_index('idx_companies_subscription_tier', 'companies', ['subscription_tier'], unique=False)
    op.create_index('idx_companies_domain', 'companies', ['domain'], unique=False)
    op.alter_column('companies', 'max_team_members',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('1'))
    op.alter_column('companies', 'max_candidate_views',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('10'))
    op.alter_column('companies', 'max_active_jobs',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('1'))
    op.drop_constraint(None, 'candidate_views', type_='foreignkey')
    op.drop_index(op.f('ix_candidate_views_id'), table_name='candidate_views')
    op.create_index('ix_candidate_views_company_created', 'candidate_views', ['company_id', 'created_at'], unique=False)
    op.drop_column('candidate_views', 'candidate_profile_id')
    op.drop_index(op.f('ix_candidate_profiles_id'), table_name='candidate_profiles')
    op.create_index('ix_candidate_profiles_visibility', 'candidate_profiles', ['visibility'], unique=False)
    op.create_index('ix_candidate_profiles_skills', 'candidate_profiles', ['skills'], unique=False, postgresql_using='gin')
    op.create_index('ix_candidate_profiles_open_to_work', 'candidate_profiles', ['open_to_work'], unique=False)
    op.create_index('ix_candidate_profiles_location', 'candidate_profiles', ['location'], unique=False)
    op.create_index('ix_candidate_profiles_experience_level', 'candidate_profiles', ['experience_level'], unique=False)
    op.create_unique_constraint('candidate_profiles_user_id_key', 'candidate_profiles', ['user_id'])
    op.alter_column('candidate_profiles', 'portfolio',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True,
               existing_server_default=sa.text("'[]'::jsonb"))
    op.alter_column('candidate_profiles', 'preferred_roles',
               existing_type=sa.JSON(),
               type_=postgresql.ARRAY(sa.VARCHAR(length=100)),
               existing_nullable=True)
    op.alter_column('candidate_profiles', 'skills',
               existing_type=sa.JSON(),
               type_=postgresql.ARRAY(sa.VARCHAR(length=100)),
               existing_nullable=True)
    op.add_column('candidate_availability', sa.Column('requested_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False))
    op.drop_index(op.f('ix_candidate_availability_candidate_id'), table_name='candidate_availability')
    op.drop_index(op.f('ix_candidate_availability_application_id'), table_name='candidate_availability')
    op.create_index('idx_candidate_availability_expires_at', 'candidate_availability', ['expires_at'], unique=False)
    op.create_index('idx_candidate_availability_candidate_id', 'candidate_availability', ['candidate_id'], unique=False)
    op.create_index('idx_candidate_availability_application_id', 'candidate_availability', ['application_id'], unique=False)
    op.alter_column('candidate_availability', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('candidate_availability', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('candidate_availability', 'timezone',
               existing_type=sa.String(length=50),
               type_=sa.VARCHAR(length=100),
               existing_nullable=False)
    op.alter_column('candidate_availability', 'available_slots',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=False)
    op.alter_column('bulk_job_uploads', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('bulk_job_uploads', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('bulk_job_uploads', 'distribution_channels',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'duplicate_info',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'validation_errors',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'enriched_jobs_data',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('bulk_job_uploads', 'raw_jobs_data',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('assessments', 'total_completions',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('assessments', 'total_attempts',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('assessments', 'track_ip_address',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.alter_column('assessments', 'require_webcam',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'max_tab_switches',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('5'))
    op.alter_column('assessments', 'allow_tab_switching',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.alter_column('assessments', 'enable_proctoring',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'show_results_immediately',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.alter_column('assessments', 'show_correct_answers',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'randomize_options',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'randomize_questions',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessments', 'max_attempts',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('1'))
    op.alter_column('assessments', 'passing_score_percentage',
               existing_type=sa.NUMERIC(precision=5, scale=2),
               nullable=True,
               existing_server_default=sa.text('70.00'))
    op.alter_column('assessment_responses', 'answer_changed_count',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_responses', 'copy_paste_detected',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_responses', 'flagged_for_review',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_responses', 'auto_graded',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('assessment_questions', 'allow_partial_credit',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.alter_column('assessment_questions', 'is_required',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.alter_column('assessment_questions', 'max_file_size_mb',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('10'))
    op.alter_column('assessment_questions', 'execution_timeout_seconds',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('10'))
    op.alter_column('assessment_attempts', 'grading_status',
               existing_type=sa.VARCHAR(length=50),
               nullable=True,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('assessment_attempts', 'tab_switch_count',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_attempts', 'questions_correct',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_attempts', 'questions_answered',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('assessment_attempts', 'auto_submitted',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.drop_index(op.f('ix_applications_source'), table_name='applications')
    op.drop_index(op.f('ix_applications_external_source'), table_name='applications')
    op.drop_index(op.f('ix_applications_external_id'), table_name='applications')
    op.create_index('idx_applications_user_updated', 'applications', ['user_id', 'updated_at'], unique=False)
    op.create_index('idx_applications_user_status_created', 'applications', ['user_id', 'status', 'created_at'], unique=False)
    op.create_index('idx_applications_user_status', 'applications', ['user_id', 'status'], unique=False)
    op.create_index('idx_applications_user_created', 'applications', ['user_id', 'created_at'], unique=False)
    op.create_index('idx_applications_user_applied', 'applications', ['user_id', 'applied_at'], unique=False)
    op.create_index('idx_applications_source', 'applications', ['source'], unique=False)
    op.drop_column('applications', 'external_source')
    op.drop_column('applications', 'external_id')
    op.drop_column('applications', 'application_mode')
    op.drop_column('applications', 'is_auto_applied')
    op.drop_index(op.f('ix_application_stage_history_changed_at'), table_name='application_stage_history')
    op.drop_index(op.f('ix_application_stage_history_application_id'), table_name='application_stage_history')
    op.alter_column('application_notes', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('application_notes', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.create_index('ix_api_keys_status', 'api_keys', ['status'], unique=False)
    op.create_index('ix_api_keys_key_prefix', 'api_keys', ['key_prefix'], unique=False)
    op.create_index('ix_api_keys_created_at', 'api_keys', ['created_at'], unique=False)
    op.create_index('ix_api_keys_company_id', 'api_keys', ['company_id'], unique=False)
    op.create_index('ix_api_key_usage_rate_limit', 'api_key_usage', ['api_key_id', 'created_at'], unique=False)
    op.create_index('ix_api_key_usage_endpoint', 'api_key_usage', ['endpoint'], unique=False)
    op.create_index('ix_api_key_usage_created_at', 'api_key_usage', ['created_at'], unique=False)
    op.create_index('ix_api_key_usage_company_id', 'api_key_usage', ['company_id'], unique=False)
    op.create_index('ix_api_key_usage_api_key_id', 'api_key_usage', ['api_key_id'], unique=False)
    op.drop_index(op.f('ix_analytics_snapshots_company_id'), table_name='analytics_snapshots')
    op.create_table('email_verification_codes',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('email', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('code', sa.VARCHAR(length=6), autoincrement=False, nullable=False),
    sa.Column('is_used', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=False),
    sa.Column('is_valid', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=False),
    sa.Column('verified_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('failed_attempts', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.PrimaryKeyConstraint('id', name='email_verification_codes_pkey')
    )
    op.create_index('ix_email_verification_codes_email', 'email_verification_codes', ['email'], unique=False)
    op.drop_index(op.f('ix_application_status_history_new_status'), table_name='application_status_history')
    op.drop_index(op.f('ix_application_status_history_changed_at'), table_name='application_status_history')
    op.drop_index(op.f('ix_application_status_history_application_id'), table_name='application_status_history')
    op.drop_table('application_status_history')
    op.drop_index(op.f('ix_webhook_events_user_id'), table_name='webhook_events')
    op.drop_index(op.f('ix_webhook_events_status'), table_name='webhook_events')
    op.drop_index(op.f('ix_webhook_events_source'), table_name='webhook_events')
    op.drop_index(op.f('ix_webhook_events_received_at'), table_name='webhook_events')
    op.drop_index(op.f('ix_webhook_events_event_type'), table_name='webhook_events')
    op.drop_index(op.f('ix_webhook_events_event_id'), table_name='webhook_events')
    op.drop_index(op.f('ix_webhook_events_application_id'), table_name='webhook_events')
    op.drop_table('webhook_events')
    op.drop_index(op.f('ix_auto_apply_jobs_user_id'), table_name='auto_apply_jobs')
    op.drop_index(op.f('ix_auto_apply_jobs_status'), table_name='auto_apply_jobs')
    op.drop_table('auto_apply_jobs')
    op.drop_index(op.f('ix_interview_questions_session_id'), table_name='interview_questions')
    op.drop_index(op.f('ix_interview_questions_id'), table_name='interview_questions')
    op.drop_table('interview_questions')
    op.drop_table('auto_apply_configs')
    op.drop_index(op.f('ix_notifications_user_id'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_type'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_is_read'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_id'), table_name='notifications')
    op.drop_index(op.f('ix_notifications_created_at'), table_name='notifications')
    op.drop_table('notifications')
    op.drop_index(op.f('ix_notification_preferences_user_id'), table_name='notification_preferences')
    op.drop_index(op.f('ix_notification_preferences_id'), table_name='notification_preferences')
    op.drop_table('notification_preferences')
    op.drop_index(op.f('ix_interview_sessions_user_id'), table_name='interview_sessions')
    op.drop_index(op.f('ix_interview_sessions_id'), table_name='interview_sessions')
    op.drop_table('interview_sessions')
    op.drop_index(op.f('ix_events_audit_user_id'), table_name='events_audit')
    op.drop_index(op.f('ix_events_audit_event_type'), table_name='events_audit')
    op.drop_table('events_audit')
    op.drop_index(op.f('ix_webhook_subscriptions_source'), table_name='webhook_subscriptions')
    op.drop_table('webhook_subscriptions')
    op.drop_index(op.f('ix_email_templates_name'), table_name='email_templates')
    op.drop_index(op.f('ix_email_templates_id'), table_name='email_templates')
    op.drop_table('email_templates')
    # ### end Alembic commands ###
